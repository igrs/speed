## Web高速化のために圧縮しよう

原文： <https://developers.google.com/speed/articles/use-compression>  
著者： Arvind Jain(エンジニアディレクター)とJason Glasgow(ソフトウェアエンジニアスタッフ)

### はじめに

毎日、[未圧縮コンテンツ](http://ja.wikipedia.org/wiki/%E3%83%87%E3%83%BC%E3%82%BF%E5%9C%A7%E7%B8%AE)のために人間の年齢で言えば99年分以上の時間が浪費されています。最近のブラウザーでは圧縮サポートは標準的に備わっている機能ですが、未だにブラウザーが圧縮されたコンテンツを受信していないというケースが多く見られます。このことは帯域幅を浪費するだけでなく、Webページの操作感も遅くしてしまいます。

未圧縮コンテンツはすべてのユーザーに害をもたらします。帯域制限のあるユーザーにとっては余計にビット転送量を増加させてしまいます。ブロードバンドユーザーにとっても、ビットデータは素早く転送されますが、クライアントとサーバー間で可能なかぎりハイスピードで通信する前にラウンドトリップタイムがかかってしまいます。このようなユーザーにとってラウンドトリップの回数はページ読み込み時間に関わる大きな要因となっています。高速な回線のユーザーにとってもラウンドトリップは数十ミリ秒から時には100ミリ秒を超えることもあります。

Steve Soudersの著書、「[続・ハイパフォーマンスWebサイト](http://www.oreilly.co.jp/books/9784873114460/)」で、Tony Gentilcoreは未圧縮のためにページの読み込み時間が増加していることを提示しました。私たちは著者の許可を得て、Alexaトップ100のうち上位3位のサイトの結果を引用します。

| Webサイト         |Alexaランキング|ダウンロードサイズの増加分<br>最初の読み込み時 | ページ読み込み時間の増加分<br>1000/384 Kbps DSL | ページ読み込み時間の増加分<br>56 Kbpsモデム |
|------------------|-------------|--------------|------------|------------|
| www.google.com   |1            |10.3KB (44%)  |0.12s (12%) |1.3s (25%)  |
| www.facebook.com |2            |348 KB (175%) |9.4s (414%) |63s (524%)  |
| www.yahoo.com    |3            |331 KB (126%) |1.2s (64%)  |9.4s (137%) |

<small>Steve Souders氏の許可のもと掲載。”第9章 Gzip圧縮再考”続・ハイパフォーマンスWebサイト――ウェブ高速化のベストプラクティス（O'Reilly Japan、2010年）</small>

GoogleのWeb検索ログからのデータによると圧縮されていないコンテンツを受信するユーザーの読み込み時間は圧縮されたコンテンツのそれよりも25%も長いことが分かりました。圧縮されたコンテンツを受信しないであろうユーザーに対して、強制的に圧縮を有効にした無作為抽出実験によると、300msものレイテンシーの改善を確認できました。この実験では十分な違いを補足できませんでしたが、ユーザーが圧縮を強制されるのはおそらくユーザーが古いコンピューター・ソフトウェアを使用しているからだと思われます。

### なぜ圧縮しないのか？

ユーザーがなぜ圧縮コンテンツを受信しないのか、4つの大きな理由があるためだと私たちは発見しました。その4つというのは、アンチウイルスソフト、ブラウザーバグ、WebプロキシーとWebサーバーによる誤設定によるものです。最初の3つに関しては[リクエスト](http://en.wikipedia.org/wiki/HTTP_request#Request_message)を改変するため、Webサーバーはブラウザーがコンテンツを解凍できることを知りません。これらは、すべてのリクエストで通常は送られるはずであるAccept-Encodingヘッダーを削除・改変してしまいます。

アンチウイルスソフトはWebサーバーに未圧縮コンテンツを送信させるために、リクエストに対して警告したり干渉することによって、CPU操作を最小限にするよう動作します。しかし、CPUがボトルネックでもない限り、これはユーザーに対してなんの恩恵もありません。いくつかの人気のアンチウイルスプログラムに関しては圧縮を妨げます。もしお使いのアンチウイルスプログラムが圧縮を妨げているかどうか確認したいのならばBrowserscope.orgの[ブラウザー圧縮テストページ](http://www.browserscope.org/network/tests/gzip)にて確認することができます。

デフォルトでIE6はプロキシー接続するとHTTP/1.0にダウングレードするので結果としてAccept-Encodingリクエストヘッダーが送信されません。以下の表は、GoogleのWeb検索ログを収集したもので、IE6はすべての検索結果の36%が圧縮なしで送信されていました。この数は実際にIE6を使用している人のパーセンテージよりもはるかに高い値となっています。

|ブラウザー           | 検索結果ページを未圧縮で<br>送信したブラウザーの割合 | 検索結果ページを未圧縮で<br>送信した合計のブラウザー別の割合|
|--------------------|---|---|
|Google Chrome       |  1|  1|
|Safari              |  1|  1|
|Firefox 3.5         |  3|  4|
|Internet Explorer 8 |  6|  5|
|Firefox 3.0         |  6|  7|
|Other               | 46| 22|
|Internet Explorer 7 |  7| 24|
|Internet Explorer 6 | 20| 36|

<small>Google Web検索ログより</small>


未圧縮コンテンツが95%以上にもなるISPが少なからず存在しています。これの1つの仮説としては、ISPもしくは企業のプロキシーがAccept-Encodingヘッダーを削除・改変している可能性があります。アンチウイルスプログラム同様に、ISPが圧縮を妨げているのではと疑問に思っている方は、Browserscope.orgの[ブラウザー圧縮テストページ](http://www.browserscope.org/network/tests/gzip)にて確認することができます。


結局、多くの場合、Webサイトが自身のコンテンツを圧縮していないため、ユーザーは未圧縮コンテンツを受信していることになります。次の表はコンテンツを圧縮していないと人気サイトを表しています。もしこれらのサイトがコンテンツを圧縮していたのならば、ページの読み込み時間を平均して数百ミリ秒は削減できますし、モデム接続ユーザーであればそれ以上の結果が望めます。

Webサイト          | リソースの種類    | 削減可能なバイト数
------------------|-----------------|-----------------
www.cnn.com       | CSSとJavaScript | 330 kB
www.twitter.com   | CSSとJavaScript |  40 kB
www.bbc.co.uk     | CSSとJavaScript | 201 kB
<small>Page Speed 評価より</small>

### どうすべきか？

未圧縮コンテンツを削減するために私たちは協力する必要があります。

+ もしプロキシーでIE6を使用しているの企業のIT部門の方、個人ユーザーの方はブラウザーをアップグレードしてください。最新の[Firefox](http://www.mozilla.jp/firefox/), [Internet Explorer](http://windows.microsoft.com/ja-JP/internet-explorer/products/ie/home), [Opera](http://jp.opera.com/), [Safari](http://www.apple.com/jp/safari/), または[Google Chrome](http://www.google.com/chrome/intl/ja/landing.html)を使用すれば圧縮コンテンツを受信する機会が増えます。IE6からのアップグレードの場合、圧縮に加えて、[IEEE Spectrun](http://spectrum.ieee.org/telecom/internet/we-come-to-bury-ie6)の最近の解説ではその他の理由も挙げています。
+ アンチウイルスソフトウェアベンダーは圧縮を適切に操作できるはずなので、直近のリリースするソフトウェアに関してはAccept-Encoding ヘッダーを削除・改変する必要はありません。
+ HTTPプロキシーを使用し、Accept-Encoding ヘッダーを削除・改変するISPの方はプロキシーをアップグレード、再設定、もしくはユーザーの圧縮コンテンツ受信を妨げないよりよいプロキシーをインストールして下さい。
+ ウェブマスターは[Page Speed](https://developers.google.com/speed/pagespeed/)もしくはそれと同様なツールを使用してページが圧縮されているかどうかチェックしてください。
