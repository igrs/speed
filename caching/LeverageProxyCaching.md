---
layout: default
category: caching
date: 2012-10-01
title: プロキシーキャッシュを活用する
---

## プロキシーキャッシュを活用する

原文：[https://developers.google.com/speed/docs/best-practices/caching#LeverageProxyCaching](https://developers.google.com/speed/docs/best-practices/caching#LeverageProxyCaching)

### Overview

公開キャッシュを有効化することで、ブラウザーに対して遠くのオリジンサーバーよりも近くのプロキシーサーバーからリソースのダウンロードが可能になる。

### Details

ブラウザーキャッシュに加えて、HTTPはプロキシーキャッシュも提供している。これは静的なリソースをパブリックなWebプロキシーサーバーでキャッシュさせることができる。最も有名なものとしてはISPのサーバーを利用するといったことが考えられる。これは最初の訪問でもキャッシュの利益を享受することができるということだ。あるユーザーからプロキシーを通して一度でもリクエストされたのであれば、そのリソースは同じプロキシーを通してリクエストする全てのユーザーで利用できるようになる。これらのプロキシーを利用する場合、サーバーよりもユーザーに地理的に近いため、プロキシーキャッシュはレイテンシーを削減することが可能だ。もし、プロキシーを有効に活用できればあなたのサーバーの帯域幅を全く利用せずにプロキシーからリソースは適用されるので、無料でWebサイトをホスティングできるだろう。


`Cache-control: public`ヘッダーを設定することでリソースをブラウザキャッシュに加えて、公開プロキシーサーバーにもキャッシュさせておくことができ、リクエストの問題を解決することができるだろう。例外（後述）を除いて、あなたのWebサーバーにはリソースをキャッシュさせるために`public`ヘッダーを設定する。


### Recommendations

__静的リソースURLにクエリー文字列をつけない__  
多くのプロキシー、その中でも最も有名なSquid Ver3.0において、"?"の文字列のついたリソースは、たとえ`Cache-control: public`を指定していてもリソースはキャッシュされない。これらのリソースをプロキシーキャッシュさせるためには、静的リソースからクエリー文字列を取り除くことが必要で、代わりにファイルネームに対してエンコードしたパラメータを付ければ問題ない。

__クッキーがセットされたリソースに対してプロキシーキャッシュさせない__  
パブリックにリソースをキャッシュし複数のユーザーで共有する場合、それはリソースにセットされたクッキーも共有すると同じ事です。多くのプロキシーがクッキーがセットされたリソースをキャッシュしないでもない限り、このリスクは避けたほうが良いでしょう。`Cache-control:`を`private`に設定するか、[クッキーレスなドメインから](https://developers.google.com/speed/docs/best-practices/request#ServeFromCookielessDomain)リソースを配信すべきでしょう。

__JavaScript/CSSファイルのプロキシーキャッシュについての問題に注意する__  
いくつかの公開プロキシーは`Content-Encoding`レスポンスヘッダーを検出しないバグを持っているため、圧縮ファイルを適切に展開できないブラウザーに対しても、圧縮ファイルを送信してしまう恐れがある。これらのファイルはあなたのサーバーによって常に[Gzip](/speed/payload/GzipCompression.html)されるべきなので、クライアントが正確に理解できるか確かめる必要があり、次のいずれかの対策をするとよい:

+ `Cache-Control`ヘッダーを`private`に設定する。こうすることでリソースのプロキシーキャッシュを無効にできる。あなたのアプリケーションが世界中で提供され、ユーザーローカリティのためにプロキシーキャッシュの依存を抑えたいのなら、この設定が適切かもしれない。
+ レスポンスヘッダーに`Vary: Accept-Encoding`を指定する。この指示はプロキシーに対してリソースを2つのバージョンで保存することを意味しており、1つは圧縮されたリソースで、もう1つは未圧縮なものだ。リソースの正しいバージョンはクライアントのリクエストヘッダーにもとづいて配信される。これはシングルホームなネットワーク、またはユーザー局所的なパブリックプロキシーに依存しているアプリケーションにとって良い選択と言える。