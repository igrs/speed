---
layout: default
category: rtt
date: 2012-10-01
title: リダイレクトの回数を減らす
---
## リダイレクトの回数を減らす

原文：[https://developers.google.com/speed/docs/best-practices/rtt#AvoidRedirects](https://developers.google.com/speed/docs/best-practices/rtt#AvoidRedirects)

### Overview

HTTPリダイレクト最小限にすることは、ユーザーの待ち時間と余計なRTTを削除することができる。

### Details

アプリケーションにおいて時折、ブラウザーをあるURLからほかのURLへ転送させる必要があるだろう。これにはWebアプリケーションがリダイレクトを発行するいくつかの理由がある。

+ 移動してしまったリソースの新しい場所を示すため
+ インプレション数とクリック数とリファラーログをトラッキングするため
+ 複数のドメインを予約するため、ユーザーフレンドリーまたは無意味なドメインを使用するため、URLのミススペル、打ち間違いをキャッチするため。
+ 異なるサイトまたはアプリケーションをつなぐため、異なる国コードとトップレベルドメインをつなぐため、異なるプロトコルHTTPからHTTPS）をつなぐため、異なるセキュリティポリシー（例：認証されていないページと認証されたページ）をつなぐためなど
+ ブラウザーがコンテンツにアクセスできるようにするために、URLの末尾のスラッシュ追加のため

いかなる理由であろうとも、リダイレクトは余計なHTTPリクエストーレスポンスサイクルとラウンドトリップタイムを発生させるトリガーとなる。あなたのアプリケーションでリダイレクトを最小限にすることは非常に重要だ（とりわけ、ホームページのような起動画面で必要なリソースは）。リダイレクトをする最適な方法は、完全に技術的にそれができないと無理なケースで、その他の解決方法も見つからない場合以外はリダイレクトを制限することだ。

### Recommendations

__不要なリダイレクトは取り除く __  
単純に不要なリダイレクトを取り除くための戦略は以下：

+ ほかのURLへリダイレクトするページのURLを参照しない。あなたのアプリケーションはリソースのロケーションに変更があるたびにURLのリファレンスをアップデートする仕組みが必要となる。
+ リソースを取得するのに1回以上のリダイレクトを使用しない。例えば、Cというターゲットページがあり、2つの違うスタート地点のA,Bというページがある場合、AとB両方とも、直接Cにリダイレクトすべきだ。Aを中間のBへリダイレクトする必要はない。
+ 実際のサーバーコンテンツを提供するのではなく、リダイレクトを発行する余計なドメインを削減する。ときどき、ドメイン名の予約と間違ったユーザー入力（ミススペル、ミスタイプURL）のために複数のドメインにリダイレクトしたい誘惑にかられる。しかし、もしユーザーを複数のURLからあなたのサイトをたどり着くように訓練するのなら、ドメイン占拠者の手からあなたの名前のバリエーションのドメインを守るために新しいドメインを買い続けるような悪循環を精算することができる。

__ユーザー入力したURLのためにサーバーリライトを使用する__  
多くの Webサーバーは内部リライトをサポートしている。これは、ある URLから別のURLにマッピングが可能だということを意味している。クライントで間違ったURLのリクエストが来た場合、サーバーは自動的に正しいものに変更し、リダイレクトなしにリソースを提供する。あなたがコントロールできないURLをキャッチするためにそれを利用すべきだ。リライトを簡単なURLリファレンス更新のために使用するべきではない。あなたは常に1つのURLで1つのリソースを参照すべきである。また可能であればキャッシュ可能なリソースのためにそれらを使用することは避ける。ディレクトリ名の最後に末尾スラッシュを自動追加するのはユーザー入力したURLに良い候補を知らせるのでリライトの仕組みで良い見本と言える。

__バックグラウンドでトラフィックを追跡する__  
様々な情報をトラフィックするために、いくつかのサイトは集約的なサーバーでページのすべての情報を収集するために媒介的なリダイレクトを使用する。しかしながら、このようなリダイレクトはページ遷移の間に余計なレイテンシーを発生させてしまうため、リダイレクトは避け、ページビューを計測する違う方法を検討するのが良い。非同期にページビューを記録する一般的な方法は、ユーザーがページを読み込んだときにログサーバーに通知し、JavaScriptスニペット（または*onload*イベントハンドラなど）をターゲット·ページの下部に含めることである。最も一般的な方法としてはサーバーに対してビーコンをリクエストすることで、ビーコンリソースのURLパラメータとしてすべてのデータをエンコードしたものを付加する。HTTPレスポンスを非常に軽微なものに維持できるため、ビーコンのリクエストは1x1ピクセルの透明画像を選択するのがよい。さらに言えば、そのビーコンは1x1のGIFよりもわずかに小さい204レスポンス（"no content"）を返すとよい。

{% highlight html %}
<script type="text/javascript">
	 var thisPage = location.href;
	 var referringPage = (document.referrer) ? document.referrer : "none";
	 var beacon = new Image();
	 beacon.src = "http://www.example.com/logger/beacon.gif?page=" + encodeURI(thisPage)
	 + "&ref=" + encodeURI(referringPage);
</script>
{% endhighlight %}

これはつまらない例だが、www.example.com/logger はログサーバーでbeacon.gifがリクエストされる画像としている。現在のページのURLと（もし存在すれば）リファラーのページのURLがパラメーターとして渡される。

このビーコンは、他の実際にページコンテンツをレンダリングするのに必要なHTTPリクエストと教護しないように、ページのHTMLの最下部に含めるべきだ。このように、このリクエストはユーザーがページを訪れた時に、追加の待ち時間を発生させずに生成される。

__JavaScriptまたはmetaリダイレクトではなく、HTTPリダイレクトをする __  
リダイレクトを発行するいくつかの方法がある：

+ サーバーサイド：Webサーバーに対して、300　HTTPレスポンスコード（一般的なのは301"moved permanently"または302 　"found"/"moved temporarily"）を新しいURLの`Location`ヘッダーに発行するように設定する。
+ クライアントサイド：metaタグの`http-equiv="refresh"`属性を使用するか、JavaScriptの`window.location`オブジェクト（の`replace`メソッド）をHTMLドキュメントの上部で使用する。

リダイレクトを使用しなければならないのなら、クライアントサイドの方法よりもサーバーサイドの方法を選択したほうが良い。ブラウザーはmetaまたはJavaScriptによるリダイレクトより、HTTPリダイレクトをハンドリングしやすい。例えば、301または302リダイレクトはHTMLドキュメントがパースされる前に即座に処理されるが、JSリダイレクトはブラウザーのパース処理のレイテンシーの影響を受けてしまう。

加えて、HTTP/1.1の仕様書によれば、301と302レスポンスはブラウザーによってキャッシュが可能だ。これはリソース自体がキャッシュ不可能であっても、ブラウザーは少なくとも、ローカルキャッシュ内の正しいURLを探せることを意味している。301レスポンスは特別な指定がないかぎりデフォルトでキャッシュ可能である。302レスポンスをキャッシュ可能にするためには、あなたはWebサーバーに対して、`Expires`または`Cache-Control max-age`ヘッダーを設定(詳細は[ブラウザキャッシュを活用する](/speed/caching/LeverageBrowserCaching.html)を参照)
する。ここでの注意点は、多くのブラウザは、実際に仕様どおりではないので、301、302レスポンス両方ともキャッシュしないかもしれない。準拠および非準拠ブラウザのリストについては[Browserscope](http://www.browserscope.org/)を参照。

### Examples

[Google Analytics](http://www.google.com/analytics)アカウントオーナーによって所有されているWebページで、インバウンド内部、およびアウトバウンドトラフィックを追跡するために、画像ビーコン方式を採用しています。アカウントオーナーは`trackPageview（）`関数を定義し、Webページ内に外部JavaScriptファイルへの参照を埋め込む。HTMLドキュメントのbody下部にはユーザーが訪問した時にコールする、JavaScriptスニペットが含まれている。`trackPageview() `関数は__utm.gifという複数のパラメータつきのURLの1x1ピクセル画像を生成する。このパラメーターはページURL、リファラー、ブラウザ環境、ユーザー地域などのような情報を明示する。Analyticsサーバーがリクエストを受信したときに、情報を記録され、アカウントオーナーがレポーティングサイトにサインインしたときに提供される。

### Additional resources
+ トラッキングコードの詳細に関しては [Google Analytics Developer Docs](http://code.google.com/apis/analytics/docs/index.html) を参照
+ Apache [URL Rewriting Guide](http://apache.org/docs/2.2/rewrite/) では、`mod_rewrite`を用いた内部リライトについて議論されている























